<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>üìã Atendimentos - Defesa Civil Cuiab√°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map {
      height: 500px;
      display: none;
      border-radius: 10px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">

    <!-- Cabe√ßalho -->
<div class="flex justify-between items-center mb-4">
  <div class="flex space-x-2">
    <a href="{{ url_for('home') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded">üè† In√≠cio</a>
    <button id="btnPainel" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">üó∫Ô∏è Painel</button>
  </div>

  <button id="btnInserir" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">‚ûï Inserir</button>
</div>


    <!-- Painel Mapa -->
    <div id="map" class="mb-4 shadow-sm border"></div>

    <!-- Tabela -->
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th>Tipo</th>
              <th>N¬∫ Laudo</th>
              <th>Bairro</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Data Vistoria</th>
              <th class="text-center">Grau de Risco</th>
              <th class="text-center">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for a in atendimentos %}
            <tr>
              <td>{{ a.origem or "‚Äì" }}</td>
              <td>{{ a.numero_laudo or "‚Äì" }}</td>
              <td>{{ a.bairro or "‚Äì" }}</td>
              <td>{{ a.latitude or "‚Äì" }}</td>
              <td>{{ a.longitude or "‚Äì" }}</td>
              <td>{{ a.data_vistoria or "‚Äì" }}</td>

              <!-- Cores do Grau de Risco -->
              <td class="text-center">
                {% if a.grau_risco %}
                  {% set risco = a.grau_risco.upper() %}
                  {% if "MUITO ALTO" in risco %}
                    <span class="badge bg-danger">{{ a.grau_risco }}</span>
                  {% elif "ALTO" in risco %}
                    <span class="badge bg-warning text-dark">{{ a.grau_risco }}</span>
                  {% elif "M√âDIO" in risco %}
                    <span class="badge bg-warning text-dark">{{ a.grau_risco }}</span>
                  {% elif "BAIXO" in risco %}
                    <span class="badge bg-success">{{ a.grau_risco }}</span>
                  {% elif "MUITO BAIXO" in risco %}
                    <span class="badge bg-success-subtle text-success">{{ a.grau_risco }}</span>
                  {% else %}
                    {{ a.grau_risco }}
                  {% endif %}
                {% else %}
                  ‚Äì
                {% endif %}
              </td>

              <!-- Bot√µes -->
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2">
                  {% if a.arquivo %}
                    <a href="{{ url_for('download_arquivo', nome_arquivo=a.arquivo) }}" 
                       class="btn btn-sm btn-primary" title="Baixar">
                      üì•
                    </a>
                  {% endif %}
                  <form method="POST" action="{{ url_for('excluir_atendimento', numero_laudo=a.numero_laudo) }}" 
                        onsubmit="return confirm('Tem certeza que deseja excluir este atendimento?');">
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir">üóëÔ∏è</button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-3">
                Nenhum atendimento registrado ainda.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Script do mapa -->
  <script>
    const mapa = L.map("map").setView([-15.6, -56.1], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapa);

    const atendimentos = {{ atendimentos_json | safe }};

    // Fun√ß√£o que retorna cor conforme o grau de risco
    function corPorRisco(risco) {
      if (!risco) return "gray";
      const r = risco.toUpperCase();
      if (r.includes("MUITO ALTO")) return "red";
      if (r.includes("ALTO")) return "orange";
      if (r.includes("M√âDIO")) return "yellow";
      if (r.includes("BAIXO")) return "green";
      if (r.includes("MUITO BAIXO")) return "lightgreen";
      return "gray";
    }

    // Cria √≠cone circular colorido
    function iconeCircular(cor) {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">
          <circle cx="16" cy="16" r="10" fill="${cor}" stroke="black" stroke-width="1"/>
        </svg>`;
      return L.icon({
        iconUrl: "data:image/svg+xml;base64," + btoa(svg),
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -28]
      });
    }

    // Adiciona marcadores
    atendimentos.forEach(a => {
      if (a.latitude && a.longitude) {
        const lat = parseFloat(a.latitude);
        const lon = parseFloat(a.longitude);
        if (!isNaN(lat) && !isNaN(lon)) {
          const tipo = a.origem || "Atendimento";
          const risco = a.grau_risco || "N√£o informado";
          const cor = corPorRisco(risco);

          const popup = `
            <div style="font-size:14px">
              <b>${tipo}</b><br>
              üìç Bairro: ${a.bairro || "-"}<br>
              üóìÔ∏è Data: ${a.data_vistoria || "-"}<br>
              ‚ö†Ô∏è Risco: <b>${risco}</b><br>
              <a href="/download/${a.arquivo}" target="_blank">üì• Baixar Laudo</a>
            </div>
          `;

          const marker = L.marker([lat, lon], { icon: iconeCircular(cor) }).addTo(mapa);
          marker.bindPopup(popup);
        }
      }
    });

    // Ajusta mapa aos pontos
    if (atendimentos.length > 0) {
      const bounds = L.latLngBounds(
        atendimentos
          .filter(a => a.latitude && a.longitude)
          .map(a => [parseFloat(a.latitude), parseFloat(a.longitude)])
      );
      if (bounds.isValid()) mapa.fitBounds(bounds, { padding: [40, 40] });
    }

    // Alternar mapa
    const btnPainel = document.getElementById("btnPainel");
    btnPainel.addEventListener("click", () => {
      const mapDiv = document.getElementById("map");
      const visivel = mapDiv.style.display === "block";
      mapDiv.style.display = visivel ? "none" : "block";
      btnPainel.textContent = visivel ? "üó∫Ô∏è Painel" : "‚ùå Fechar Painel";
      if (!visivel) mapa.invalidateSize();
    });
  </script>


  <!-- Modal Inser√ß√£o -->
<div id="modalInserir" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">Inserir Atendimento Manualmente</h3>
    <form id="formInserir" class="space-y-3">
      <div>
        <label class="block text-sm font-medium">Tipo</label>
        <select name="origem" class="w-full border rounded p-2">
          <option>Chuvas</option>
          <option>Regulariza√ß√£o</option>
          <option>Inc√™ndios</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium">N¬∫ Laudo</label>
        <input type="text" name="numero_laudo" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm font-medium">Bairro</label>
        <input type="text" name="bairro" class="w-full border rounded p-2">
      </div>
      <div class="flex space-x-2">
        <div class="flex-1">
          <label class="block text-sm font-medium">Latitude</label>
          <input type="text" name="latitude" class="w-full border rounded p-2">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium">Longitude</label>
          <input type="text" name="longitude" class="w-full border rounded p-2">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Data Vistoria</label>
        <input type="date" name="data_vistoria" class="w-full border rounded p-2">
      </div>
      <div>
        <label class="block text-sm font-medium">Grau de Risco</label>
        <select name="grau_risco" class="w-full border rounded p-2">
          <option>MUITO BAIXO</option>
          <option>BAIXO</option>
          <option>M√âDIO</option>
          <option>ALTO</option>
          <option>MUITO ALTO</option>
        </select>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" id="cancelarInserir" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById("modalInserir");
  const btnInserir = document.getElementById("btnInserir");
  const cancelar = document.getElementById("cancelarInserir");

  btnInserir.onclick = () => modal.classList.remove("hidden");
  cancelar.onclick = () => modal.classList.add("hidden");

  document.getElementById("formInserir").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const dados = Object.fromEntries(formData.entries());

    const res = await fetch("/inserir_atendimento", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dados)
    });

    if (res.ok) {
      modal.classList.add("hidden");
      location.reload();
    } else {
      alert("Erro ao inserir atendimento.");
    }
  });
</script>

</body>
</html>

