<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Atendimentos - Defesa Civil CuiabÃ¡</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- CabeÃ§alho -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ Painel de Atendimentos</h1>
      <a href="{{ url_for('home') }}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium">â¬… Voltar</a>
    </div>

    <!-- Mapa -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-2">ğŸ—ºï¸ Mapa dos Atendimentos</h2>
      <div id="map" class="w-full h-96 rounded-lg shadow-md border border-gray-200"></div>
    </div>

    <!-- Tabela -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Tipo</th>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">NÂº Laudo</th>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Bairro</th>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Latitude</th>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Longitude</th>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Data Vistoria</th>
            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 text-center">Grau de Risco</th>
            <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 bg-white">
          {% for a in atendimentos %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2">{{ a.origem or "â€“" }}</td>
            <td class="px-4 py-2">{{ a.numero_laudo or "â€“" }}</td>
            <td class="px-4 py-2">{{ a.bairro or "â€“" }}</td>
            <td class="px-4 py-2">{{ a.latitude or "â€“" }}</td>
            <td class="px-4 py-2">{{ a.longitude or "â€“" }}</td>
            <td class="px-4 py-2">{{ a.data_vistoria or "â€“" }}</td>

            <!-- Grau de risco colorido -->
            <td class="px-4 py-2 text-center">
              {% if a.grau_risco %}
                {% set risco = a.grau_risco.upper() %}
                
                {% if "MUITO ALTO" in risco %}
                  <span class="px-2 py-1 rounded bg-red-200 text-red-800 font-semibold">
                    {{ a.grau_risco }}
                  </span>
                {% elif "ALTO" in risco %}
                  <span class="px-2 py-1 rounded bg-orange-200 text-orange-800 font-semibold">
                    {{ a.grau_risco }}
                  </span>
                {% elif "MÃ‰DIO" in risco %}
                  <span class="px-2 py-1 rounded bg-yellow-200 text-yellow-800 font-semibold">
                    {{ a.grau_risco }}
                  </span>
                {% elif "BAIXO" in risco %}
                  <span class="px-2 py-1 rounded bg-green-300 text-green-900 font-semibold">
                    {{ a.grau_risco }}
                  </span>
                {% elif "MUITO BAIXO" in risco %}
                  <span class="px-2 py-1 rounded bg-green-100 text-green-700 font-semibold">
                    {{ a.grau_risco }}
                  </span>
                {% else %}
                  {{ a.grau_risco }}
                {% endif %}
              {% else %}
                â€“
              {% endif %}
            </td>

            <td class="px-4 py-2 text-center">
              <a href="{{ url_for('download_arquivo', nome_arquivo=a.arquivo) }}"
                 class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium">
                 ğŸ“¥ Download
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-gray-500 py-6">
              Nenhum atendimento registrado ainda.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Script Leaflet -->
  <script>
    const map = L.map("map").setView([-15.6, -56.1], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const atendimentos = {{ atendimentos_json | safe }};

    const icones = {
      "Chuvas": L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/1163/1163624.png",
        iconSize: [28, 28]
      }),
      "RegularizaÃ§Ã£o FundiÃ¡ria": L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/484/484167.png",
        iconSize: [28, 28]
      }),
      "IncÃªndios": L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/482/482541.png",
        iconSize: [28, 28]
      })
    };

    atendimentos.forEach(a => {
      if (a.latitude && a.longitude) {
        const lat = parseFloat(a.latitude);
        const lon = parseFloat(a.longitude);
        if (!isNaN(lat) && !isNaN(lon)) {
          const tipo = a.origem || "Atendimento";
          const risco = a.grau_risco || "NÃ£o informado";

          let cor = "âšª";
          if (risco.toUpperCase().includes("MUITO ALTO")) cor = "ğŸ”´";
          else if (risco.toUpperCase().includes("ALTO")) cor = "ğŸŸ ";
          else if (risco.toUpperCase().includes("MÃ‰DIO")) cor = "ğŸŸ¡";
          else if (risco.toUpperCase().includes("BAIXO")) cor = "ğŸŸ¢";
          else if (risco.toUpperCase().includes("MUITO BAIXO")) cor = "ğŸŸ©";

          const popup = `
            <div style="font-size:14px">
              <b>${tipo}</b><br>
              ğŸ“ Bairro: ${a.bairro || "-"}<br>
              ğŸ—“ï¸ Data: ${a.data_vistoria || "-"}<br>
              âš ï¸ Grau: ${cor} ${risco}<br>
              <a href="/download/${a.arquivo}" target="_blank" class="text-blue-600 hover:underline">ğŸ“¥ Baixar Laudo</a>
            </div>
          `;

          const marker = L.marker([lat, lon], { icon: icones[tipo] || undefined }).addTo(map);
          marker.bindPopup(popup);
        }
      }
    });

    if (atendimentos.length > 0) {
      const bounds = L.latLngBounds(
        atendimentos
          .filter(a => a.latitude && a.longitude)
          .map(a => [parseFloat(a.latitude), parseFloat(a.longitude)])
      );
      if (bounds.isValid()) map.fitBounds(bounds, { padding: [40, 40] });
    }
  </script>
</body>
</html>
