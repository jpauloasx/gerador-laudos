<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Atendimentos - Defesa Civil CuiabÃ¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map {
      height: 500px;
      display: none;
      border-radius: 10px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">

    <!-- CabeÃ§alho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary fw-bold">ğŸ“‹ Atendimentos Realizados</h2>
      <div>
        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-sm me-2">ğŸ  InÃ­cio</a>
        <button id="btnPainel" class="btn btn-outline-primary btn-sm">ğŸ—ºï¸ Painel</button>
      </div>
    </div>

    <!-- Painel Mapa -->
    <div id="map" class="mb-4 shadow-sm border"></div>

    <!-- Tabela -->
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th>Tipo</th>
              <th>NÂº Laudo</th>
              <th>Bairro</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Data Vistoria</th>
              <th class="text-center">Grau de Risco</th>
              <th class="text-center">AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody>
            {% for a in atendimentos %}
            <tr>
              <td>{{ a.origem or "â€“" }}</td>
              <td>{{ a.numero_laudo or "â€“" }}</td>
              <td>{{ a.bairro or "â€“" }}</td>
              <td>{{ a.latitude or "â€“" }}</td>
              <td>{{ a.longitude or "â€“" }}</td>
              <td>{{ a.data_vistoria or "â€“" }}</td>

              <!-- Cores do Grau de Risco -->
              <td class="text-center">
                {% if a.grau_risco %}
                  {% set risco = a.grau_risco.upper() %}
                  {% if "MUITO ALTO" in risco %}
                    <span class="badge bg-danger">{{ a.grau_risco }}</span>
                  {% elif "ALTO" in risco %}
                    <span class="badge bg-warning text-dark">{{ a.grau_risco }}</span>
                  {% elif "MÃ‰DIO" in risco %}
                    <span class="badge bg-warning text-dark">{{ a.grau_risco }}</span>
                  {% elif "BAIXO" in risco %}
                    <span class="badge bg-success">{{ a.grau_risco }}</span>
                  {% elif "MUITO BAIXO" in risco %}
                    <span class="badge bg-success-subtle text-success">{{ a.grau_risco }}</span>
                  {% else %}
                    {{ a.grau_risco }}
                  {% endif %}
                {% else %}
                  â€“
                {% endif %}
              </td>

              <td class="text-center">
                <a href="{{ url_for('download_arquivo', nome_arquivo=a.arquivo) }}" class="btn btn-sm btn-primary">
                  ğŸ“¥ Download
                </a>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-3">
                Nenhum atendimento registrado ainda.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Script do mapa -->
  <script>
    const mapa = L.map("map").setView([-15.6, -56.1], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapa);

    const atendimentos = {{ atendimentos_json | safe }};
    // FunÃ§Ã£o que retorna cor conforme o grau de risco
function corPorRisco(risco) {
  if (!risco) return "gray";
  const r = risco.toUpperCase();
  if (r.includes("MUITO ALTO")) return "red";
  if (r.includes("ALTO")) return "orange";
  if (r.includes("MÃ‰DIO")) return "yellow";
  if (r.includes("BAIXO")) return "green";
  if (r.includes("MUITO BAIXO")) return "lightgreen";
  return "gray";
}

// FunÃ§Ã£o para criar Ã­cone circular colorido
function iconeCircular(cor) {
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">
      <circle cx="16" cy="16" r="10" fill="${cor}" stroke="black" stroke-width="1"/>
    </svg>`;
  return L.icon({
    iconUrl: "data:image/svg+xml;base64," + btoa(svg),
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -28]
  });
}

// Adiciona marcadores com Ã­cones coloridos
atendimentos.forEach(a => {
  if (a.latitude && a.longitude) {
    const lat = parseFloat(a.latitude);
    const lon = parseFloat(a.longitude);
    if (!isNaN(lat) && !isNaN(lon)) {
      const tipo = a.origem || "Atendimento";
      const risco = a.grau_risco || "NÃ£o informado";
      const cor = corPorRisco(risco);

      const popup = `
        <div style="font-size:14px">
          <b>${tipo}</b><br>
          ğŸ“ Bairro: ${a.bairro || "-"}<br>
          ğŸ—“ï¸ Data: ${a.data_vistoria || "-"}<br>
          âš ï¸ Risco: <b>${risco}</b><br>
          <a href="/download/${a.arquivo}" target="_blank">ğŸ“¥ Baixar Laudo</a>
        </div>
      `;

      const marker = L.marker([lat, lon], { icon: iconeCircular(cor) }).addTo(mapa);
      marker.bindPopup(popup);
    }
  }
});


    atendimentos.forEach(a => {
      if (a.latitude && a.longitude) {
        const lat = parseFloat(a.latitude);
        const lon = parseFloat(a.longitude);
        if (!isNaN(lat) && !isNaN(lon)) {
          const tipo = a.origem || "Atendimento";
          const risco = a.grau_risco || "NÃ£o informado";

          let cor = "âšª";
          if (risco.toUpperCase().includes("MUITO ALTO")) cor = "ğŸ”´";
          else if (risco.toUpperCase().includes("ALTO")) cor = "ğŸŸ ";
          else if (risco.toUpperCase().includes("MÃ‰DIO")) cor = "ğŸŸ¡";
          else if (risco.toUpperCase().includes("BAIXO")) cor = "ğŸŸ¢";
          else if (risco.toUpperCase().includes("MUITO BAIXO")) cor = "ğŸŸ©";

          const popup = `
            <div style="font-size:14px">
              <b>${tipo}</b><br>
              ğŸ“ Bairro: ${a.bairro || "-"}<br>
              ğŸ—“ï¸ Data: ${a.data_vistoria || "-"}<br>
              âš ï¸ Risco: ${cor} ${risco}<br>
              <a href="/download/${a.arquivo}" target="_blank">ğŸ“¥ Baixar Laudo</a>
            </div>
          `;

          const marker = L.marker([lat, lon], { icon: icones[tipo] || undefined }).addTo(mapa);
          marker.bindPopup(popup);
        }
      }
    });

    if (atendimentos.length > 0) {
      const bounds = L.latLngBounds(
        atendimentos
          .filter(a => a.latitude && a.longitude)
          .map(a => [parseFloat(a.latitude), parseFloat(a.longitude)])
      );
      if (bounds.isValid()) mapa.fitBounds(bounds, { padding: [40, 40] });
    }

    // Alternar mapa
    const btnPainel = document.getElementById("btnPainel");
    btnPainel.addEventListener("click", () => {
      const mapDiv = document.getElementById("map");
      const visivel = mapDiv.style.display === "block";
      mapDiv.style.display = visivel ? "none" : "block";
      btnPainel.textContent = visivel ? "ğŸ—ºï¸ Painel" : "âŒ Fechar Painel";
      if (!visivel) mapa.invalidateSize();
    });
  </script>

</body>
</html>
