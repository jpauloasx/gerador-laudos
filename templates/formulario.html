<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Relat√≥rio - An√°lise Defesa Civil de Cuiab√°-MT</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
  <div class="container py-4 px-3 px-md-5">

   <!-- VOLTAR -->
    <div class="d-flex justify-content-end mb-3">
      <a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-sm">Voltar</a>
    </div>

    <!-- LOGOS -->
    <div class="row justify-content-center align-items-center mb-4">
      <div class="col-auto">
        <img src="{{ url_for('static', filename='defesa_civil.jpeg') }}" class="img-fluid" style="max-height: 100px;">
      </div>
      <div class="col-auto">
        <img src="{{ url_for('static', filename='pref_cba.jpeg') }}" class="img-fluid" style="max-height: 100px;">
      </div>
    </div>

    <!-- T√çTULO -->
    <h2 class="mb-4 text-center text-primary">Gerador de Relat√≥rio T√©cnico</h2>

    <!-- FORMUL√ÅRIO -->
    <form method="POST" enctype="multipart/form-data">
      
    <!-- Campos principais, tratando CPF, Telefone e Data com m√°scaras de preenchimento e geoloc -->
{% for label, name in campos %}
  <div class="mb-3">
    <label class="form-label">{{ label }}</label>

    {% if name == "cpf" %}
      <input type="text" name="cpf" id="cpf" class="form-control" maxlength="14" required>

    {% elif name == "telefone" %}
      <input type="text" name="telefone" id="telefone" class="form-control" maxlength="15" required>

    {% elif name == "data_vistoria" %}
      <input type="text" name="data_vistoria" id="data_vistoria" class="form-control" maxlength="10" required>

    {% elif name == "data_relatorio" %}
    <input type="text" name="data_relatorio" id="data_relatorio" class="form-control" maxlength="10" required>

{% elif name == "latitude" %}
  <button type="button" class="btn btn-sm btn-outline-primary mb-2" onclick="atualizarLocalizacao()">
    üìç Atualizar Localiza√ß√£o
  </button>
  <input type="text" name="latitude" id="latitude" class="form-control mb-1" readonly>
  <a id="link_mapa" class="btn btn-sm btn-outline-secondary" target="_blank" style="display:none;">
    üåç Ver no Mapa
  </a>


    {% elif name == "longitude" %}
      <input type="text" name="longitude" id="longitude" class="form-control" readonly>

    {% else %}
      <input type="text" name="{{ name }}" class="form-control" required>
    {% endif %}
  </div>
{% endfor %}

      <!-- Grupos de solo -->
      <div class="mb-4">
        <h5>Caracter√≠sticas do Solo</h5>
        <select class="form-select" name="problemas_solo" multiple>
          <option>Arenoso</option>
          <option>Argiloso</option>
          <option>Alta declividade</option>
          <option>Alta satura√ß√£o h√≠drica (encharcado)</option>
        </select>
        <input type="text" name="problemas_solo_outro" class="form-control mt-2" placeholder="Outro tipo de solo...">
      </div> -->

      <div class="mb-4">
        <h5>Presen√ßa de cursos d'√°gua</h5>
        <select class="form-select" name="presenca_cursos" multiple>
          <option>C√≥rrego</option>
          <option>Rio</option>
          <option>Riacho</option>
          <option>Len√ßol fre√°tico</option>
          <option>N√£o identificado</option>
        </select>
        <input type="text" name="presenca_cursos_outro" class="form-control mt-2" placeholder="Outro tipo de curso...">
      </div>
      </div>

      <div class="mb-4">
        <h5>Sinais de instabilidade</h5>
        <select class="form-select" name="sinais_instabilidade" multiple>
          <option>Trincas e Rachaduras</option>
          <option>Eros√£o</option>
          <option>Inclina√ß√£o</option>
          <option>Deslizamento</option>
          <option>Infiltra√ß√£o</option>
        </select>
      </div>

      <div class="mb-4">
        <h5>Potenciais fatores de risco</h5>
        <select class="form-select" name="fatores_risco" multiple>
          <option>Ac√∫mulo de √°gua</option>
          <option>Aus√™ncia e/ou defici√™ncia de drenagem</option>
          <option>Desn√≠veis acentuados no terreno</option>
          <option>Macro-fissuras em muros, indicando movimenta√ß√£o do solo</option>
          <option>Ocupa√ß√µes em √°reas suscet√≠veis a alagamento e/ou escorregamento</option>
        </select>
      </div>

      <!-- Grau de Risco -->
      <div class="mb-3">
        <label class="form-label">Grau de Risco</label>
        <select name="grau_risco" class="form-select">
          <option>MUITO BAIXO</option>
          <option>BAIXO</option>
          <option selected>M√âDIO</option>
          <option>ALTO</option>
          <option>MUITO ALTO</option>
        </select>
      </div>

<!-- Imagens e descri√ß√µes -->
  <h4 class="mt-5 mb-3">Imagens e Descri√ß√µes</h4>
{% for i in range(1, 8) %}
  {% if i == 1 %}
    <div id="imagem1_block">
  {% endif %}

  <div class="mb-2">
    <label class="form-label">Imagem {{ i }}</label>
    <input type="file" name="imagem{{ i }}" class="form-control">
  </div>
  <div class="mb-4">
    <input type="text" name="descricao{{ i }}" class="form-control" placeholder="Descri√ß√£o da imagem {{ i }}">
  </div>

  {% if i == 1 %}
    </div>
  {% endif %}
{% endfor %}


      <!-- Bot√µes -->
      <div class="d-grid gap-2 mt-4">
        <button type="submit" class="btn btn-primary">‚úÖ Gerar Laudo</button>
        <button type="button" class="btn btn-outline-danger" onclick="confirmarLimpeza()">üóëÔ∏è Limpar Tudo</button>
      </div>
    </form>
  </div>

 <!-- Script de m√°scara do CPF, Telefone e Data-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // CPF
  const cpfInput = document.getElementById("cpf");
  if (cpfInput) {
    cpfInput.addEventListener("input", function () {
      let valor = cpfInput.value.replace(/\D/g, "");
      if (valor.length > 11) valor = valor.slice(0, 11);
      let formatado = "";
      if (valor.length > 0) formatado = valor.slice(0, 3);
      if (valor.length >= 4) formatado += "." + valor.slice(3, 6);
      if (valor.length >= 7) formatado += "." + valor.slice(6, 9);
      if (valor.length >= 10) formatado += "-" + valor.slice(9, 11);
      cpfInput.value = formatado;
    });
  }

  // TELEFONE
  const telInput = document.getElementById("telefone");
  if (telInput) {
    telInput.addEventListener("input", function () {
      let valor = telInput.value.replace(/\D/g, "");
      if (valor.length > 11) valor = valor.slice(0, 11);

      let formatado = "";
      if (valor.length > 0) formatado = "(" + valor.slice(0, 2);
      if (valor.length >= 3) formatado += ") " + valor.slice(2, 7);
      if (valor.length >= 8) formatado += "-" + valor.slice(7, 11);

      telInput.value = formatado;
    });
  }
  // DATA
  const dataInput = document.getElementById("data_vistoria");
  if (dataInput) {
    dataInput.addEventListener("input", function () {
      let valor = dataInput.value.replace(/\D/g, "");
      if (valor.length > 8) valor = valor.slice(0, 8);

      let formatado = "";
      if (valor.length > 0) formatado = valor.slice(0, 2);
      if (valor.length >= 3) formatado += "/" + valor.slice(2, 4);
      if (valor.length >= 5) formatado += "/" + valor.slice(4, 8);

      dataInput.value = formatado;
    });
  }
});
</script>

<!-- Leaflet + html2canvas para gerar imagem do minimapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Campo oculto com imagem base64 -->
<input type="hidden" name="imagem1_base64" id="imagem1_base64">

<!-- Container invis√≠vel do mapa -->
<div id="map-container" style="width: 300px; height: 300px; display: none;"></div>

<script>
  function atualizarLocalizacao() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);

          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lon;

          document.getElementById("imagem1_block").style.display = "none";

          const linkMapa = document.getElementById("link_mapa");
          if (linkMapa) {
            linkMapa.href = `https://www.google.com/maps?q=${lat},${lon}`;
            linkMapa.style.display = "inline-block";
          }

          // Renderiza minimapa
          const container = document.getElementById("map-container");
          container.style.display = "block";
          container.innerHTML = ""; // limpa inst√¢ncia anterior

          const mapa = L.map("map-container").setView([lat, lon], 16);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap',
          }).addTo(mapa);
          L.marker([lat, lon]).addTo(mapa);

          setTimeout(() => {
            html2canvas(container).then(canvas => {
              const base64 = canvas.toDataURL("image/png");
              document.getElementById("imagem1_base64").value = base64;
              container.style.display = "none"; // oculta novamente
            });
          }, 1000); // espera mapa carregar
        },
        function (error) {
          alert("Erro ao obter localiza√ß√£o: " + error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      alert("Geolocaliza√ß√£o n√£o suportada.");
    }
  }
</script>


<script>
  document.getElementById("btn-atualizar-localizacao").addEventListener("click", function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        document.querySelector("input[name='latitude']").value = position.coords.latitude.toFixed(6);
        document.querySelector("input[name='longitude']").value = position.coords.longitude.toFixed(6);

        // Oculta o campo da Imagem 1 (div com id="imagem1_block")
        const img1 = document.getElementById("imagem1_block");
        if (img1) {
          img1.style.display = "none";
        }
      }, function (error) {
        alert("Erro ao obter localiza√ß√£o. Adicione manualmente.");
      });
    } else {
      alert("Geolocaliza√ß√£o n√£o suportada pelo navegador.");
    }
  });
</script>


  <!-- Script de limpeza -->
  <script>
    function confirmarLimpeza() {
      if (confirm("Tem certeza que deseja limpar todos os campos do formul√°rio?")) {
        limparFormulario();
      }
    }

    function limparFormulario() {
      document.querySelectorAll('input[type="text"]').forEach(el => el.value = "");
      document.querySelectorAll('select[multiple]').forEach(select => {
        Array.from(select.options).forEach(option => option.selected = false);
      });
      document.querySelectorAll('input[type="file"]').forEach(el => el.value = "");
      document.querySelectorAll('select:not([multiple])').forEach(select => {
        select.selectedIndex = 0;
      });
    }
  </script>
</body>
</html>
