<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Defesa Civil Cuiab√°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto py-8 px-4">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center space-x-4">
        <img src="{{ url_for('static', filename='pref_cba.jpeg') }}" class="h-14 w-auto" alt="Prefeitura de Cuiab√°">
        <img src="{{ url_for('static', filename='defesa_civil.jpeg') }}" class="h-14 w-auto" alt="Defesa Civil Cuiab√°">
      </div>
      <a href="{{ url_for('home') }}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded shadow">
        ‚¨ÖÔ∏è In√≠cio
      </a>
    </div>

    <h1 class="text-3xl font-bold text-center text-orange-600 mb-10">üìä Dashboard de Atendimentos</h1>

    <!-- Painel de Resumo -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white shadow-md rounded-xl p-5 text-center">
        <h3 class="text-gray-600 text-sm">Total de Atendimentos</h3>
        <p id="totalAtendimentos" class="text-3xl font-bold text-blue-600 mt-2">0</p>
      </div>
      <div class="bg-white shadow-md rounded-xl p-5 text-center">
        <h3 class="text-gray-600 text-sm">Chuvas</h3>
        <p id="chuvasCount" class="text-3xl font-bold text-gray-600 mt-2">0</p>
      </div>
      <div class="bg-white shadow-md rounded-xl p-5 text-center">
        <h3 class="text-gray-600 text-sm">Regulariza√ß√£o</h3>
        <p id="regularizacaoCount" class="text-3xl font-bold text-blue-600 mt-2">0</p>
      </div>
      <div class="bg-white shadow-md rounded-xl p-5 text-center">
        <h3 class="text-gray-600 text-sm">Inc√™ndios</h3>
        <p id="incendiosCount" class="text-3xl font-bold text-red-600 mt-2">0</p>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Distribui√ß√£o por Tipo de Atendimento</h2>
        <canvas id="graficoTipo"></canvas>
      </div>

      <div class="bg-white shadow-lg rounded-xl p-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Distribui√ß√£o por Grau de Risco</h2>
        <canvas id="graficoRisco"></canvas>
      </div>

      <div class="bg-white shadow-lg rounded-xl p-6 lg:col-span-2">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Atendimentos por Bairro</h2>
        <canvas id="graficoBairro"></canvas>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    async function carregarDashboard() {
      const res = await fetch("/painel_dados");
      const atendimentos = await res.json();

      // Totais gerais
      document.getElementById("totalAtendimentos").textContent = atendimentos.length;
      document.getElementById("chuvasCount").textContent = atendimentos.filter(a => a.origem?.toLowerCase().includes("chuva")).length;
      document.getElementById("regularizacaoCount").textContent = atendimentos.filter(a => a.origem?.toLowerCase().includes("regular")).length;
      document.getElementById("incendiosCount").textContent = atendimentos.filter(a => a.origem?.toLowerCase().includes("inc√™ndio")).length;

      // Distribui√ß√£o por tipo
      const tipos = ["Chuvas", "Regulariza√ß√£o", "Inc√™ndios"];
      const dadosTipo = tipos.map(t => atendimentos.filter(a => a.origem?.toLowerCase().includes(t.toLowerCase())).length);

      new Chart(document.getElementById("graficoTipo"), {
        type: "pie",
        data: {
          labels: tipos,
          datasets: [{
            data: dadosTipo,
            backgroundColor: ["#6b7280", "#3b82f6", "#ef4444"]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });

 // Distribui√ß√£o por risco
const riscos = ["MUITO BAIXO", "BAIXO", "M√âDIO", "ALTO", "MUITO ALTO"];
const coresRisco = ["#86efac", "#22c55e", "#eab308", "#f97316", "#dc2626"];

const dadosRisco = riscos.map(r => 
  atendimentos.filter(a => (a.grau_risco || "").toUpperCase().trim() === r).length
);

new Chart(document.getElementById("graficoRisco"), {
  type: "doughnut",
  data: {
    labels: riscos,
    datasets: [{
      data: dadosRisco,
      backgroundColor: coresRisco
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { position: "bottom" } }
  }
});


      // Atendimentos por bairro
      const bairros = {};
      atendimentos.forEach(a => {
        const b = a.bairro || "N√£o informado";
        bairros[b] = (bairros[b] || 0) + 1;
      });
      const labelsBairro = Object.keys(bairros);
      const valoresBairro = Object.values(bairros);

      new Chart(document.getElementById("graficoBairro"), {
        type: "bar",
        data: {
          labels: labelsBairro,
          datasets: [{
            label: "Atendimentos",
            data: valoresBairro,
            backgroundColor: "#3b82f6"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }
        }
      });
    }

    carregarDashboard();
  </script>
</body>
</html>
